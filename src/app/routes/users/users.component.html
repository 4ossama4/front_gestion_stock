<page-header [title]="'gestion des utlisateurs'"></page-header>
<nz-card [nzBodyStyle]="{ padding: '18px' }" class="mt-5" style="border-radius: 5px" [nzBordered]="true">
  <div class="row d-flex align-items-center">
    <div class="col-md-6">
      <h4 class="mb-0 title-page">Liste des utlisateurs</h4>
    </div>
    <div class="col-md-6 d-flex justify-content-end">
      <button (click)="openModalAdd()" class="d-flex align-items-center" nz-button nzType="primary">
        Utilisateur <i nz-icon nzType="plus"></i>
      </button>
    </div>
  </div>
  <hr />
  <div class="row pt-3">
    <div class="col-md-12">
      <nz-table
        [nzTotal]="totalUsers"
        [nzFrontPagination]="false"
        [(nzPageIndex)]="firstUser"
        [nzPageSizeOptions]="[10, 50, 100]"
        [(nzPageSize)]="maxResults"
        [nzShowPagination]="true"
        nzShowSizeChanger
        nzOuterBordered
        [nzLoading]="loading"
        [nzSize]="'middle'"
        #basicTable
        [nzData]="listOfUsers"
        (nzQueryParams)="sort($event)"
      >
        <thead>
          <tr>
            <th>Utilisateur</th>
            <th>Télephone</th>
            <th>Fixe</th>
            <th>Role</th>
            <th class="text-center pl-3 pr-3">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let data of basicTable.data">
            <td>{{ data.name }}</td>
            <td>{{ data.telephone }}</td>
            <td>{{ data.fixe }}</td>
            <td>
              <nz-tag [nzColor]="'green'">{{ data.role?.name }}</nz-tag>
            </td>
            <td class="text-center">
              <i (click)="deleteUser(data.id)" class="fal fa-trash-alt mr-2 my-btn-delete"></i>
              <i (click)="openModalUpdate(data)" class="fal fa-pen my-btn-edit mr-2"></i>
              <i (click)="openModalUpdatePassword(data)" class="fal fa-lock-alt my-btn-edit c-green"></i>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </div>
  </div>
</nz-card>

<nz-modal
  [nzMaskClosable]="false"
  [(nzVisible)]="userModal"
  [nzTitle]="!isUpdate ? 'Ajouter utilisateur' : 'Modifier l\'utilisateur'"
  (nzOnCancel)="closeModalAdd()"
>
  <form [formGroup]="userForm">
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="last_name">Nom</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <input formControlName="last_name" nz-input name="last_name" type="text" id="last_name" />
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="first_name">Prénom</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <input formControlName="first_name" nz-input name="first_name" type="text" id="first_name" />
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="name">Nom d'utilisateur</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <input (keyup)="findUser($event)" formControlName="name" nz-input name="name" type="text" id="name" />
            <span
              *ngIf="find_user_name && userSelected?.name?.toLowerCase() != userForm?.value?.name?.toLowerCase() && userForm.value.name"
              style="font-size: 12px; color: red"
            >
              ce nom est déja utilisé
            </span>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="email">Email</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <input formControlName="email" nz-input name="email" type="email" email id="email" />
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="telephone">Télephone</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <input formControlName="telephone" nz-input name="telephone" type="text" id="telephone" />
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="fixe">Fixe</nz-form-label>
          <nz-form-control [nzSpan]="16">
            <input formControlName="fixe" nz-input name="fixe" type="text" id="fixe" />
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="cin">CIN</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <input formControlName="cin" nz-input name="cin" type="text" id="cin" />
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="role_id">Role</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <nz-select nzAllowClear nzShowSearch style="width: 100%" formControlName="role_id" name="role_id" id="role_id">
              <nz-option *ngFor="let role of listOfRoles" [nzLabel]="role.name" [nzValue]="role.id"> </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div *ngIf="!isUpdate" nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="password">Mot de passe</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <nz-input-group [nzSuffix]="suffixIconSearch">
              <input
                nz-input
                [type]="showPassword ? 'text' : 'password'"
                id="password"
                formControlName="password"
                (ngModelChange)="updateConfirmValidator()"
              />
            </nz-input-group>
            <ng-template #suffixIconSearch>
              <i
                style="cursor: pointer"
                [ngClass]="{ 'fa-eye': !showPassword, 'fa-eye-slash': showPassword }"
                class="fal"
                (click)="showPassword = !showPassword"
              ></i>
            </ng-template>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="password_confirmation">Confirmation</nz-form-label>
          <nz-form-control [nzErrorTip]="errorTpl" [nzSpan]="16">
            <input nz-input type="password" formControlName="password_confirmation" id="password_confirmation" />
            <ng-template #errorTpl let-control>
              <ng-container *ngIf="control.hasError('required')"> Veuillez confirmer votre mot de passe! </ng-container>
              <ng-container *ngIf="control.hasError('confirm')"> Deux mots de passe que vous saisissez sont incohérents! </ng-container>
            </ng-template>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="addresse">Adresse</nz-form-label>
          <nz-form-control [nzSpan]="16">
            <textarea rows="3" nz-input formControlName="addresse"></textarea>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div *nzModalFooter>
      <button (click)="closeModalAdd()" nz-button nzType="default">Annuler</button>

      <button *ngIf="!isUpdate" (click)="saveUser()" nz-button nzType="primary">Enregistrer</button>
      <button *ngIf="isUpdate" (click)="saveUser()" nz-button nzType="primary">Modifier</button>
    </div>
  </form>
</nz-modal>

<nz-modal
  [nzMaskClosable]="false"
  [(nzVisible)]="modalPassword"
  [nzTitle]="'Modifier mot de passe d\'utilisateur  ' + nameUser"
  (nzOnCancel)="hideModalUpdatePassword()"
>
  <form [formGroup]="userPasswordForm">
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="10" nzFor="old_password">Ancien Mot de passe</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="14">
            <nz-input-group [nzSuffix]="suffixIconSearchOld">
              <input nz-input [type]="showPasswordOld ? 'text' : 'password'" id="old_password" formControlName="old_password" />
            </nz-input-group>
            <ng-template #suffixIconSearchOld>
              <i
                style="cursor: pointer"
                [ngClass]="{ 'fa-eye': !showPasswordOld, 'fa-eye-slash': showPasswordOld }"
                class="fal"
                (click)="showPasswordOld = !showPasswordOld"
              ></i>
            </ng-template>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="10" nzFor="password">Nouveau Mot de passe</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="14">
            <nz-input-group [nzSuffix]="suffixIconSearch">
              <input
                nz-input
                [type]="showPassword ? 'text' : 'password'"
                id="password"
                formControlName="password"
                (ngModelChange)="updateConfirmValidatorPass()"
              />
            </nz-input-group>
            <ng-template #suffixIconSearch>
              <i
                style="cursor: pointer"
                [ngClass]="{ 'fa-eye': !showPassword, 'fa-eye-slash': showPassword }"
                class="fal"
                (click)="showPassword = !showPassword"
              ></i>
            </ng-template>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="10" nzFor="password_confirmation">Confirmation</nz-form-label>
          <nz-form-control [nzErrorTip]="errorTpl" [nzSpan]="14">
            <input nz-input type="password" formControlName="password_confirmation" id="password_confirmation" />
            <ng-template #errorTpl let-control>
              <ng-container *ngIf="control.hasError('required')"> Veuillez confirmer votre mot de passe! </ng-container>
              <ng-container *ngIf="control.hasError('confirm')"> Deux mots de passe que vous saisissez sont incohérents! </ng-container>
            </ng-template>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div *nzModalFooter>
      <button (click)="hideModalUpdatePassword()" nz-button nzType="default">Annuler</button>
      <button (click)="changePasswor()" nz-button nzType="primary">Modifier</button>
    </div>
  </form>
</nz-modal>
