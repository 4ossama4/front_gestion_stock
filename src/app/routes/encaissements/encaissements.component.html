<page-header [title]="''"></page-header>
<nz-card [nzBodyStyle]="{ padding: '18px' }" class="mt-5" style="border-radius: 5px" [nzBordered]="true">
  <div class="row d-flex align-items-center">
    <div class="col-md-6 col-6">
      <h4 class="mb-0 title-page">Liste des encaissements</h4>
    </div>
    <div class="col-md-6 col-6 d-flex justify-content-end">
      <button *ngIf="ROLE_ADD" (click)="openModalAdd()" class="d-flex align-items-center" nz-button nzType="primary">
        Encaissement <i nz-icon nzType="plus"></i>
      </button>
    </div>
  </div>
  <hr />
  <div class="row">
    <div class="col-lg-10 col-md-10 col-12 filter-rupture">
      <nz-input-group [nzSize]="'small'" style="width: 100%" [nzAddOnAfter]="searchClient">
        <nz-select
          (ngModelChange)="changeClientFilter($event)"
          [nzPlaceHolder]="'Chercher par Client'"
          [(ngModel)]="encaissementCriteria.client"
          nzAllowClear
          nzShowSearch
          style="width: 30%"
        >
          <nz-option *ngFor="let client of listOfClients" [nzLabel]="client.name" [nzValue]="client"> </nz-option>
        </nz-select>
        <nz-select
          (ngModelChange)="changeModePaimentFilter($event)"
          [nzPlaceHolder]="'Chercher par Mode'"
          [(ngModel)]="encaissementCriteria.paymentMethod"
          nzAllowClear
          nzShowSearch
          style="width: 30%"
        >
          <nz-option *ngFor="let mode of listOfPaymentsMode" [nzLabel]="mode.label" [nzValue]="mode"> </nz-option>
        </nz-select>
        <nz-range-picker
          style="width: 40% !important"
          #rangePicker
          [nzRenderExtraFooter]="extraDate"
          [(ngModel)]="encaissementCriteria.date"
          (ngModelChange)="onChange($event)"
        ></nz-range-picker>
        <ng-template #extraDate>
          <div class="text-center">
            <button [nzSize]="'small'" (click)="toDay('30J')" nz-button nzType="primary"><< 30 jours</button>
            <button [nzSize]="'small'" (click)="toDay('7J')" nz-button nzType="primary"><< 7 jours</button>
            <button [nzSize]="'small'" (click)="toDay('HIER')" nz-button nzType="primary"><< Hier</button>
            <button [nzSize]="'small'" (click)="toDay('TODAY')" nz-button nzType="primary">aujourd'hui</button>
          </div>
        </ng-template>
      </nz-input-group>
      <ng-template #searchClient>
        <i style="cursor: pointer" (click)="searchClientMode()" class="fal fa-search bg-purple"></i>
      </ng-template>
    </div>
    <div style="padding-right: 3.5rem !important" class="col-md-2 col-12 pt-2 text-right">
      <i (click)="exportData('excel')" style="font-size: 22px; color: green; cursor: pointer" class="fal fa-file-excel mr-2"></i>
      <i (click)="exportData('pdf')" style="font-size: 22px; color: magenta; cursor: pointer" class="fal fa-file-pdf"></i>
    </div>
  </div>
  <div *ngIf="filterApplyList.length > 0" class="row pt-3 pb-1">
    <div class="col-md-10">
      <span style="font-weight: 600; color: #1890ff" class="pr-3"> <i class="fal fa-filter"></i> Filtres appliqués : </span>
      <span *ngFor="let filter of filterApplyList; let index = index">
        <nz-tag (nzOnClose)="deleteFilter(index, filter)" [nzMode]="'closeable'" [nzColor]="filter.color">
          {{ filter.label }} : {{ filter.name ? filter.name : filter.value }}</nz-tag
        >
      </span>
    </div>
    <div class="col-md-2 text-right">
      <a (click)="deleteAllfilter()" class="pl-0 pr-0" style="color: #e01372; border-bottom: 1px solid" nz-button nzType="link"
        >Supprimer les filters</a
      >
      <i style="color: #e01372" class="fal fa-trash"></i>
    </div>
  </div>
  <div class="row pt-3">
    <div class="col-md-12">
      <ng-template #datasize>
        <span class="mr-3">
          Affichage {{ from }} à {{ to }} de <strong>{{ totalEncaissement }}</strong> encaissements
        </span>
      </ng-template>
      <nz-table
        [nzShowTotal]="datasize"
        [nzTotal]="totalEncaissement"
        [nzFrontPagination]="false"
        [(nzPageIndex)]="firstEncaissement"
        [nzPageSizeOptions]="[10, 50, 100]"
        [(nzPageSize)]="maxResults"
        [nzShowPagination]="true"
        nzShowSizeChanger
        nzOuterBordered
        [nzLoading]="loading"
        [nzSize]="'middle'"
        #basicTable
        [nzData]="listOfEncaissement"
        (nzQueryParams)="sort($event)"
        [nzScroll]="{ x: '800px' }"
      >
        <thead>
          <tr>
            <th nzCustomFilter>Date</th>
            <th nzCustomFilter>Client</th>
            <th nzCustomFilter>Mode Paiement</th>
            <th nzCustomFilter>Montant</th>
            <th nzRight class="text-center pl-3 pr-3">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let data of basicTable.data">
            <td>{{ data.date }}</td>
            <td>{{ data.client?.name }}</td>
            <td>{{ data.payment_mode?.label }}</td>
            <td>{{ data.montant | priceFormat }} DH</td>
            <td nzRight class="text-center">
              <i *ngIf="ROLE_DELETE" (click)="deleteEncaissement(data.id)" class="fal fa-trash-alt mr-2 my-btn-delete"></i>
              <i *ngIf="ROLE_UPDATE" (click)="openModalUpdate(data)" class="fal fa-pen my-btn-edit mr-2"></i>
              <!-- <i (click)="view(data)" class="fal fa-eye my-btn-edit c-green"></i> -->
            </td>
          </tr>
        </tbody>
      </nz-table>
    </div>
  </div>
</nz-card>

<nz-modal
  [nzMaskClosable]="false"
  [(nzVisible)]="encaissementModal"
  [nzTitle]="isUpdate == false ? 'Ajouter Encaissement' : 'Modifier Encaissement '"
  (nzOnCancel)="closeModalAdd()"
>
  <form [formGroup]="encaissementForm">
    <div nz-row [nzGutter]="24">
      <div nz-col [nzMd]="12" [nzSm]="24" [nzXs]="24">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="date">Date </nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <nz-date-picker formControlName="date"></nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzMd]="12" [nzSm]="24" [nzXs]="24">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="name">Client</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <nz-select
              [compareWith]="nzCompareSelectedByID"
              (ngModelChange)="selectClient($event)"
              nzAllowClear
              nzShowSearch
              style="width: 100%"
              formControlName="client"
              name="client"
              id="client"
            >
              <nz-option *ngFor="let client of listOfClients" [nzLabel]="client.name" [nzValue]="client"> </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzMd]="12" [nzSm]="24" [nzXs]="24">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="payment_mode_id">Mode de paiment </nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <nz-select
              nzAllowClear
              nzShowSearch
              style="width: 100%"
              (ngModelChange)="changeModePaiment($event)"
              formControlName="payment_mode_id"
              name="payment_mode_id"
              id="payment_mode_id"
            >
              <nz-option *ngFor="let mode of listOfPaymentsMode" [nzLabel]="mode.label" [nzValue]="mode.id"> </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzMd]="12" [nzSm]="24" [nzXs]="24">
        <nz-form-item>
          <nz-form-label [nzSpan]="8" nzFor="date">Montant </nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <nz-input-number style="width: 100%" formControlName="montant" [nzMin]="0"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div class="p-3" style="background: #d9d9d9; border-radius: 3px" nz-row [nzGutter]="24" formGroupName="chequeInfo" *ngIf="modalCheque">
      <div nz-col [nzMd]="12" [nzSm]="24" [nzXs]="24">
        <nz-form-item class="mb-0">
          <nz-form-label [nzSpan]="8" nzFor="date">Date d'échéance</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <nz-date-picker formControlName="date"></nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzMd]="12" [nzSm]="24" [nzXs]="24">
        <nz-form-item class="mb-0">
          <nz-form-label [nzSpan]="8" nzFor="date">Réference</nz-form-label>
          <nz-form-control nzErrorTip="Ce champs est obligatoire" [nzSpan]="16">
            <input nz-input formControlName="reference" />
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div *nzModalFooter>
      <button (click)="closeModalAdd()" nz-button nzType="default">Annuler</button>

      <button *ngIf="!isUpdate" (click)="saveEncaissement()" nz-button nzType="primary">Enregistrer</button>
      <button *ngIf="isUpdate" (click)="saveEncaissement()" nz-button nzType="primary">Modifier</button>
    </div>
  </form>
</nz-modal>
